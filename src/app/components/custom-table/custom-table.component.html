<div class="custom-table-wrapper">
  <!-- Toast for messages -->
  <p-toast position="top-right"></p-toast>

  <!-- Toolbar -->
  <div class="table-toolbar" *ngIf="selectedRows.length > 0 || config.editable">
    <div class="toolbar-left">
      <!-- Selection Info -->
      <div *ngIf="selectedRows.length > 0" class="selection-badge">
        <i class="pi pi-check-circle"></i>
        <span>{{ selectedRows.length }} selected</span>
        <button
          pButton
          icon="pi pi-times"
          class="p-button-text p-button-sm clear-btn"
          (click)="clearSelection()"
          pTooltip="Clear selection">
        </button>
      </div>
    </div>

    <div class="toolbar-right">
      <!-- Export Button -->
      <button
        pButton
        icon="pi pi-download"
        [label]="getExportLabel()"
        class="export-btn"
        (click)="exportToCSV()">
      </button>

      <!-- Add Row (Editable mode only) -->
      <button
        *ngIf="config.editable"
        pButton
        icon="pi pi-plus"
        label="Add Row"
        class="add-row-btn"
        (click)="addNewRow()">
      </button>
    </div>
  </div>

  <!-- Table Container -->
  <div class="table-container">
    <table class="custom-table">
      <!-- Header -->
      <thead>
        <tr>
          <!-- Select All Column -->
          <th *ngIf="config.showSelectButton" class="select-column">
            <button
              class="select-btn"
              [class.selected]="isAllSelected()"
              [class.indeterminate]="isSomeSelected()"
              (click)="$event.stopPropagation(); toggleSelectAll()"
              pTooltip="Select all">
              <i class="pi pi-check" *ngIf="isAllSelected()"></i>
              <i class="pi pi-minus" *ngIf="isSomeSelected()"></i>
            </button>
          </th>

          <!-- Row Number Column -->
          <th *ngIf="config.showRowNumbers" class="row-number-column">
            <div class="header-content">#</div>
          </th>

          <!-- Data Columns -->
          <th *ngFor="let column of columns" [style.width]="column.width">
            <div class="header-content">{{ column.header }}</div>
          </th>

          <!-- Expand / Actions Column Header -->
          <th class="expand-header-th">
            <button
              class="header-expand-btn"
              (click)="onExpandButtonClick.emit()"
              pTooltip="Expand table"
              tooltipPosition="left">
              <i class="pi pi-window-maximize"></i>
            </button>
          </th>
        </tr>
      </thead>

      <!-- Body -->
      <tbody>
        <!-- Empty State -->
        <tr *ngIf="displayData.length === 0 && !config.editable" class="empty-row">
          <td [attr.colspan]="columns.length + (config.showSelectButton ? 1 : 0) + (config.showRowNumbers ? 1 : 0) + 1">
            <div class="empty-state">
              <i class="pi pi-inbox"></i>
              <p>No data available</p>
            </div>
          </td>
        </tr>

        <!-- Data Rows -->
        <tr
          *ngFor="let row of displayData; trackBy: trackByRowId"
          [class.selected-row]="isRowSelected(row)"
          [class.parent-row]="isParentRow(row)"
          [class.child-row]="isChildRow(row)"
          (mousedown)="$event.preventDefault()">

          <!-- Select Button -->
          <td *ngIf="config.showSelectButton" class="select-column"
              [class.child-select-cell]="isChildRow(row)">
            <button
              class="select-btn"
              [class.selected]="isRowSelected(row)"
              (mousedown)="$event.stopPropagation(); $event.preventDefault()"
              (click)="$event.stopPropagation(); toggleRowSelection(row)">
              <i class="pi pi-check" *ngIf="isRowSelected(row)"></i>
            </button>
          </td>

          <!-- Row Number Cell -->
          <td *ngIf="config.showRowNumbers" class="row-number-column"
              (mousedown)="$event.stopPropagation(); $event.preventDefault()">
            <div class="row-number">{{ getDisplayRowNumber(row) }}</div>
          </td>

          <!-- Data Cells -->
          <td *ngFor="let column of columns"
              [class.editable-cell]="canEditCell(column)"
              [class.primary-field-cell]="!config.editable && column.field === primaryField"
              [class.child-data-cell]="isChildRow(row)"
              (mousedown)="$event.stopPropagation(); $event.preventDefault()"
              (click)="$event.stopPropagation(); canEditCell(column) && startEdit(row, column.field)">

            <!-- Normal Display -->
            <div *ngIf="!isEditing(row, column.field)" class="cell-content">
              <span>{{ row[column.field] }}</span>
              <i *ngIf="!config.editable && column.field === primaryField"
                 class="pi pi-pencil primary-field-icon"></i>
            </div>

            <!-- Edit Mode -->
            <input
              #cellInput
              *ngIf="isEditing(row, column.field)"
              type="text"
              class="cell-input"
              [(ngModel)]="tempEditValue"
              (blur)="saveEdit(row, column.field)"
              (keydown)="onKeyDown($event, row, column.field)"
              (click)="$event.stopPropagation()"
              (mousedown)="$event.stopPropagation()"
              [placeholder]="!config.editable && column.field === primaryField ? 'Enter Message ID...' : ''">
          </td>

          <!-- Expand / Chevron Column -->
          <td class="expand-column">
            <!-- Parent row with children: show chevron -->
            <button
              *ngIf="isParentRow(row) && hasChildren(row)"
              class="row-expand-btn"
              (mousedown)="$event.stopPropagation(); $event.preventDefault()"
              (click)="$event.stopPropagation(); toggleRowExpand(row)"
              [pTooltip]="isRowExpanded(row) ? 'Collapse' : 'Expand'"
              tooltipPosition="left">
              <i class="pi"
                 [ngClass]="isRowExpanded(row) ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
            </button>
          </td>
        </tr>

        <!-- Placeholder rows for empty editable table -->
        <ng-container *ngIf="config.editable && displayData.length === 0">
          <tr *ngFor="let _ of [].constructor(10); let i = index" class="placeholder-row">
            <td *ngIf="config.showSelectButton" class="select-column">
              <div class="empty-cell"></div>
            </td>
            <td *ngIf="config.showRowNumbers" class="row-number-column">
              <div class="empty-cell"></div>
            </td>
            <td *ngFor="let column of columns">
              <div class="empty-cell"></div>
            </td>
            <td class="expand-column">
              <div class="empty-cell"></div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>

  <!-- Pagination (only non-editable mode) -->
  <div class="table-pagination" *ngIf="config.pagination && !config.editable && totalPages > 1">
    <div class="pagination-info">
      Page {{ currentPage }} of {{ totalPages }}
    </div>

    <div class="pagination-controls">
      <button
        pButton
        icon="pi pi-angle-left"
        class="p-button-text p-button-sm"
        [disabled]="currentPage === 1"
        (click)="previousPage()">
      </button>

      <button
        *ngFor="let page of getPageNumbers()"
        pButton
        [label]="page.toString()"
        class="p-button-text p-button-sm page-btn"
        [class.active-page]="page === currentPage"
        (click)="goToPage(page)">
      </button>

      <button
        pButton
        icon="pi pi-angle-right"
        class="p-button-text p-button-sm"
        [disabled]="currentPage === totalPages"
        (click)="nextPage()">
      </button>
    </div>
  </div>

  <!-- Floating Action Dialog (Editable mode only) -->
  <div
    *ngIf="config.editable"
    class="floating-actions-dialog">
    <div class="floating-actions-content">
      <span class="selection-count" *ngIf="selectedRows.length > 0">{{ selectedRows.length }} Selected</span>

      <div class="action-buttons">
        <button
          pButton
          icon="pi pi-save"
          class="p-button-text action-btn"
          (click)="saveSelectedRows()"
          pTooltip="Save Selected"
          tooltipPosition="top">
        </button>

        <button
          pButton
          icon="pi pi-sort-alt"
          class="p-button-text action-btn"
          (click)="swapParentChild()"
          pTooltip="Swap Parent with Child"
          tooltipPosition="top">
        </button>

        <button
          pButton
          icon="pi pi-arrow-up"
          class="p-button-text action-btn"
          (click)="assignAsParent()"
          pTooltip="Assign as Parent"
          tooltipPosition="top">
        </button>

        <button
          pButton
          icon="pi pi-trash"
          class="p-button-text action-btn delete-btn"
          (click)="deleteSelectedRows()"
          pTooltip="Delete Selected"
          tooltipPosition="top">
        </button>
      </div>
    </div>
  </div>
</div>
